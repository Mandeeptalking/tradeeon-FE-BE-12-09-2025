name: Security Scans

on:
  schedule:
    # Run weekly on Mondays at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual runs
  push:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'apps/api/**'
      - '.github/workflows/security-scans.yml'

jobs:
  ssl-labs-scan:
    name: SSL Labs Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run SSL Labs API Scan
        id: ssl_scan
        continue-on-error: true
        run: |
          echo "Starting SSL Labs scan for www.tradeeon.com..."
          
          # Start scan
          SCAN_RESPONSE=$(curl -s "https://api.ssllabs.com/api/v3/analyze?host=www.tradeeon.com&startNew=on&all=done&publish=off")
          
          # Check if scan started successfully
          STATUS=$(echo $SCAN_RESPONSE | jq -r '.status // "ERROR"')
          
          if [ "$STATUS" = "ERROR" ]; then
            echo "Failed to start scan: $SCAN_RESPONSE"
            echo "scan_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Scan started. Status: $STATUS. Waiting for results..."
          
          # Wait for scan to complete (max 5 minutes)
          MAX_WAIT=300
          ELAPSED=0
          SLEEP_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
            
            STATUS_RESPONSE=$(curl -s "https://api.ssllabs.com/api/v3/analyze?host=www.tradeeon.com")
            STATUS=$(echo $STATUS_RESPONSE | jq -r '.status // "ERROR"')
            GRADE=$(echo $STATUS_RESPONSE | jq -r '.endpoints[0].grade // "N/A"')
            
            echo "Status: $STATUS, Grade: $GRADE (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" = "READY" ]; then
              echo "Scan completed!"
              echo "grade=$GRADE" >> $GITHUB_OUTPUT
              echo "scan_success=true" >> $GITHUB_OUTPUT
              
              # Save full report
              echo "$STATUS_RESPONSE" > ssl-labs-report.json
              
              # Extract key metrics
              echo "$STATUS_RESPONSE" | jq '.' > ssl-labs-report-formatted.json
              
              break
            fi
            
            if [ "$STATUS" = "ERROR" ]; then
              echo "Scan failed with error"
              echo "scan_success=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          
          if [ "$STATUS" != "READY" ]; then
            echo "Scan timed out after ${MAX_WAIT}s"
            echo "scan_success=false" >> $GITHUB_OUTPUT
            # Save partial report if available
            if [ -n "$STATUS_RESPONSE" ]; then
              echo "$STATUS_RESPONSE" > ssl-labs-report.json
              echo "$STATUS_RESPONSE" | jq '.' > ssl-labs-report-formatted.json
            fi
          fi

      - name: Upload SSL Labs Report
        if: steps.ssl_scan.outputs.scan_success == 'true' || (steps.ssl_scan.outcome == 'success' && hashFiles('ssl-labs-report.json') != '')
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ssl-labs-report
          path: |
            ssl-labs-report.json
            ssl-labs-report-formatted.json
          retention-days: 90

      - name: Check Grade
        if: steps.ssl_scan.outputs.scan_success == 'true'
        run: |
          GRADE="${{ steps.ssl_scan.outputs.grade }}"
          echo "SSL Labs Grade: $GRADE"
          
          if [ "$GRADE" != "A" ] && [ "$GRADE" != "A+" ]; then
            echo "⚠️ SSL Labs grade is $GRADE (expected A or A+)"
            exit 1
          else
            echo "✅ SSL Labs grade is $GRADE"
          fi

  security-headers-scan:
    name: Security Headers Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Security Headers Scan
        run: |
          echo "Scanning security headers for www.tradeeon.com..."
          
          # Get headers
          HEADERS=$(curl -sI "https://www.tradeeon.com")
          
          # Check for required headers
          MISSING_HEADERS=()
          
          if ! echo "$HEADERS" | grep -qi "strict-transport-security"; then
            MISSING_HEADERS+=("Strict-Transport-Security")
          fi
          
          if ! echo "$HEADERS" | grep -qi "content-security-policy"; then
            MISSING_HEADERS+=("Content-Security-Policy")
          fi
          
          if ! echo "$HEADERS" | grep -qi "x-content-type-options"; then
            MISSING_HEADERS+=("X-Content-Type-Options")
          fi
          
          if ! echo "$HEADERS" | grep -qi "x-frame-options"; then
            MISSING_HEADERS+=("X-Frame-Options")
          fi
          
          if ! echo "$HEADERS" | grep -qi "referrer-policy"; then
            MISSING_HEADERS+=("Referrer-Policy")
          fi
          
          # Save headers report
          echo "$HEADERS" > security-headers-report.txt
          
          # Use securityheaders.com API if available, or parse manually
          echo "=== Security Headers Report ===" > security-headers-summary.txt
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-headers-summary.txt
          echo "" >> security-headers-summary.txt
          echo "$HEADERS" >> security-headers-summary.txt
          
          if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
            echo "❌ Missing headers: ${MISSING_HEADERS[*]}" >> security-headers-summary.txt
            echo "❌ Missing headers: ${MISSING_HEADERS[*]}"
            exit 1
          else
            echo "✅ All required security headers present" >> security-headers-summary.txt
            echo "✅ All required security headers present"
          fi

      - name: Upload Security Headers Report
        uses: actions/upload-artifact@v4
        with:
          name: security-headers-report
          path: |
            security-headers-report.txt
            security-headers-summary.txt
          retention-days: 90

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [ssl-labs-scan, security-headers-scan]
    if: always()
    steps:
      - name: Download SSL Labs Report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ssl-labs-report
          path: ssl-labs/

      - name: Download Security Headers Report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: security-headers-report
          path: headers/

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create Summary
        run: |
          echo "# Security Scan Summary" > security-scan-summary.md
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-scan-summary.md
          echo "" >> security-scan-summary.md
          
          echo "## SSL Labs Test" >> security-scan-summary.md
          if [ -f ssl-labs/ssl-labs-report-formatted.json ]; then
            GRADE=$(jq -r '.endpoints[0].grade // "N/A"' ssl-labs/ssl-labs-report-formatted.json 2>/dev/null || echo "N/A")
            if [ "$GRADE" != "N/A" ] && [ "$GRADE" != "null" ]; then
              echo "- **Grade:** $GRADE" >> security-scan-summary.md
              echo "- **Report:** See artifacts" >> security-scan-summary.md
            else
              echo "- **Status:** Scan completed but grade not available" >> security-scan-summary.md
              echo "- **Report:** See artifacts" >> security-scan-summary.md
            fi
          else
            echo "- **Status:** Report not available (scan may have failed or timed out)" >> security-scan-summary.md
            echo "- **Note:** SSL Labs scans can take several minutes. Check the ssl-labs-scan job logs for details." >> security-scan-summary.md
          fi
          
          echo "" >> security-scan-summary.md
          echo "## Security Headers" >> security-scan-summary.md
          if [ -f headers/security-headers-summary.txt ]; then
            cat headers/security-headers-summary.txt >> security-scan-summary.md
          else
            echo "- **Status:** Report not available" >> security-scan-summary.md
          fi
          
          cat security-scan-summary.md

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-summary
          path: security-scan-summary.md
          retention-days: 90

